generator client {
   provider = "prisma-client-js"
}

datasource db {
   provider = "postgresql"
   url      = env("DATABASE_URL")
}

model User {
   id        String   @id @default(cuid())
   email     String   @unique
   password  String
   firstName String
   lastName  String
   role      UserRole @default(GUEST)

   avatar                   String?
   createdAt                DateTime                @default(now())
   updatedAt                DateTime                @updatedAt
   businessAddress          String?
   businessEmail            String?
   fullName                 String
   emailVerificationExpires DateTime?
   emailVerificationToken   String?
   isEmailVerified          Boolean                 @default(false)
   referralSource           String?
   referredByRealtorId      String?
   adminAuditLogs           AuditLog[]              @relation("AdminAuditLogs")
   auditLogs                AuditLog[]
   bookings                 Booking[]
   notificationPreference   NotificationPreference?
   notifications            Notification[]
   payments                 Payment[]
   platformSettings         PlatformSettings[]
   realtor                  Realtor?
   adminRefundRequests      RefundRequest[]         @relation("RefundAdmin")
   refundRequests           RefundRequest[]         @relation("RefundRequester")
   reviewResponses          ReviewResponse[]
   reviews                  Review[]
   referredByRealtor        Realtor?                @relation("ReferredGuests", fields: [referredByRealtorId], references: [id])
   openedDisputes           Dispute[]               @relation("DisputeOpener")
   adminDisputes            Dispute[]               @relation("DisputeAdmin")
   sentMessages             Message[]               @relation("SentMessages")
   receivedMessages         Message[]               @relation("ReceivedMessages")
   favorites                Favorite[]

   @@map("users")
}

model Realtor {
   id                 String   @id @default(cuid())
   userId             String   @unique
   businessName       String
   slug               String   @unique
   logoUrl            String?
   isActive           Boolean  @default(true)
   createdAt          DateTime @default(now())
   updatedAt          DateTime @updatedAt
   accentColor        String?  @default("#F59E0B")
   corporateRegNumber String?
   primaryColor       String   @default("#000000")
   secondaryColor     String?  @default("#10B981")
   tagline            String?
   websiteUrl         String?

   cacDocumentUrl            String?
   description               String?
   status                    RealtorStatus   @default(PENDING)
   cacRejectedAt             DateTime?
   cacRejectionReason        String?
   cacStatus                 CacStatus       @default(PENDING)
   cacVerifiedAt             DateTime?
   canAppeal                 Boolean         @default(true)
   suspendedAt               DateTime?
   suspensionExpiresAt       DateTime?
   paystackSubAccountCode    String?
   flutterwaveSubAccountCode String?
   averageRating             Decimal?        @default(0) @db.Decimal(3, 2)
   reviewCount               Int             @default(0)
   properties                Property[]
   user                      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
   refundRequests            RefundRequest[]
   referredGuests            User[]          @relation("ReferredGuests")

   @@map("realtors")
}

model Property {
   id                  String          @id @default(cuid())
   realtorId           String
   title               String
   description         String
   type                PropertyType
   pricePerNight       Decimal         @db.Decimal(10, 2)
   currency            String          @default("NGN")
   maxGuests           Int
   bedrooms            Int
   bathrooms           Int
   address             String
   city                String
   country             String
   isActive            Boolean         @default(true)
   createdAt           DateTime        @default(now())
   updatedAt           DateTime        @updatedAt
   amenities           String[]        @default([])
   customAmenities     String[]        @default([])
   state               String?
   status              PropertyStatus  @default(DRAFT)
   averageRating       Decimal?        @default(0) @db.Decimal(3, 2)
   reviewCount         Int             @default(0)
   cleanlinessRating   Decimal?        @default(0) @db.Decimal(3, 2)
   communicationRating Decimal?        @default(0) @db.Decimal(3, 2)
   checkInRating       Decimal?        @default(0) @db.Decimal(3, 2)
   accuracyRating      Decimal?        @default(0) @db.Decimal(3, 2)
   locationRating      Decimal?        @default(0) @db.Decimal(3, 2)
   valueRating         Decimal?        @default(0) @db.Decimal(3, 2)
   // Optional fees set by realtor
   serviceFee          Decimal?        @db.Decimal(10, 2)
   cleaningFee         Decimal?        @db.Decimal(10, 2)
   securityDeposit     Decimal?        @db.Decimal(10, 2)
   // Check-in/out and access information
   checkInTime         String?
   checkOutTime        String?
   accessInstructions  String?         @db.Text
   houseRules          String?         @db.Text
   wifiName            String?
   wifiPassword        String?
   parkingInstructions String?         @db.Text
   bookings            Booking[]
   notifications       Notification[]
   realtor             Realtor         @relation(fields: [realtorId], references: [id], onDelete: Cascade)
   images              PropertyImage[]
   reviews             Review[]
   messages            Message[]
   favorites           Favorite[]

   @@map("properties")
}

model PropertyImage {
   id         String   @id @default(cuid())
   propertyId String
   url        String
   order      Int      @default(0)
   property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

   @@map("property_images")
}

model Booking {
   id            String         @id @default(cuid())
   propertyId    String
   guestId       String
   checkInDate   DateTime
   checkOutDate  DateTime
   checkInTime   DateTime? // Actual check-in timestamp
   checkOutTime  DateTime? // Actual check-out timestamp
   totalGuests   Int
   totalPrice    Decimal        @db.Decimal(10, 2)
   currency      String         @default("NGN")
   status        BookingStatus  @default(PENDING)
   paymentStatus PaymentStatus? @default(INITIATED) // Track payment status directly in booking

   // Fee breakdown (for transparency)
   roomFee         Decimal @default(0) @db.Decimal(10, 2)
   cleaningFee     Decimal @default(0) @db.Decimal(10, 2)
   securityDeposit Decimal @default(0) @db.Decimal(10, 2)
   serviceFee      Decimal @default(0) @db.Decimal(10, 2) // 2% of (roomFee + cleaningFee)
   platformFee     Decimal @default(0) @db.Decimal(10, 2) // 10% of roomFee (deducted at release)

   // New commission flow fields
   checkinConfirmedAt       DateTime? // Timestamp when check-in was confirmed
   checkinConfirmationType  String? // "GUEST_CONFIRMED" | "REALTOR_CONFIRMED" | "AUTO_FALLBACK"
   roomFeeReleaseEligibleAt DateTime? // 1 hour after check-in confirmation
   depositRefundEligibleAt  DateTime? // 4 hours after check-out
   cleaningFeeReleasedAt    DateTime? // Immediate release timestamp
   serviceFeeCollectedAt    DateTime? // Immediate collection timestamp
   guestDisputeTier         String? // "TIER_1_SEVERE" | "TIER_2_PARTIAL" | "TIER_3_ABUSE"
   realtorDisputeOutcome    String? // "WIN" | "LOSS" | "PARTIAL"
   disputeRefundAmount      Decimal?  @db.Decimal(10, 2) // Calculated refund based on tier
   depositDeductionAmount   Decimal?  @db.Decimal(10, 2) // Amount deducted from deposit for damages

   // Dispute timers
   disputeWindowClosesAt  DateTime? // 1 hour after check-in
   realtorDisputeClosesAt DateTime? // 4 hours after checkout (updated from 2 hours)
   userDisputeOpened      Boolean   @default(false)
   realtorDisputeOpened   Boolean   @default(false)

   // Legacy fields (keeping for compatibility)
   refundCutoffTime  DateTime?
   payoutEligibleAt  DateTime?
   payoutStatus      PayoutStatus @default(PENDING)
   payoutCompletedAt DateTime?
   refundTier        RefundTier?
   specialRequests   String?

   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt

   guest          User            @relation(fields: [guestId], references: [id], onDelete: Cascade)
   property       Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
   notifications  Notification[]
   payment        Payment?
   refundRequests RefundRequest[]
   review         Review?
   disputes       Dispute[]
   escrowEvents   EscrowEvent[]
   messages       Message[]

   @@map("bookings")
}

model Payment {
   id         String        @id @default(cuid())
   bookingId  String        @unique
   userId     String
   amount     Decimal       @db.Decimal(10, 2)
   currency   String        @default("NGN")
   status     PaymentStatus @default(INITIATED)
   method     PaymentMethod
   reference  String?       @unique
   providerId String? // "PAYSTACK" or "FLUTTERWAVE"

   // Payment breakdown
   roomFeeAmount         Decimal @default(0) @db.Decimal(10, 2)
   cleaningFeeAmount     Decimal @default(0) @db.Decimal(10, 2)
   securityDepositAmount Decimal @default(0) @db.Decimal(10, 2)
   serviceFeeAmount      Decimal @default(0) @db.Decimal(10, 2)
   platformFeeAmount     Decimal @default(0) @db.Decimal(10, 2)

   // Escrow tracking
   roomFeeInEscrow   Boolean   @default(false)
   depositInEscrow   Boolean   @default(false)
   roomFeeReleasedAt DateTime?
   depositReleasedAt DateTime?

   // Payout tracking
   cleaningFeePaidOut  Boolean @default(false)
   serviceFeeCollected Boolean @default(false)
   roomFeeSplitDone    Boolean @default(false)
   depositRefunded     Boolean @default(false)

   // New commission flow tracking
   cleaningFeeReleasedToRealtor  Boolean  @default(false)
   cleaningFeeReleaseReference   String? // Payment gateway reference for cleaning fee release
   serviceFeeCollectedByPlatform Boolean  @default(false)
   roomFeeSplitRealtorAmount     Decimal? @db.Decimal(10, 2) // 90% of room fee
   roomFeeSplitPlatformAmount    Decimal? @db.Decimal(10, 2) // 10% of room fee
   roomFeeSplitReleaseReference  String? // Payment gateway reference for room fee split
   disputeRefundProcessed        Boolean  @default(false)
   disputeRefundReference        String? // Payment gateway reference for dispute refund
   depositDeductionProcessed     Boolean  @default(false)
   depositPartialRefundAmount    Decimal? @db.Decimal(10, 2) // Remaining deposit after deduction
   depositPartialRefundReference String? // Payment gateway reference for partial deposit refund

   // Manual payout tracking
   realtorTransferInitiated DateTime? // When realtor initiated manual payout
   realtorTransferCompleted DateTime? // When payout was completed
   realtorTransferReference String? // Payment gateway reference for realtor payout
   transferFailed           Boolean   @default(false) // Whether transfer failed

   // Legacy fields
   metadata              Json?
   paidAt                DateTime?
   refundAmount          Decimal?  @db.Decimal(10, 2)
   providerTransactionId String?
   refundedAt            DateTime?
   commissionPaidOut     Boolean   @default(false)
   commissionRate        Decimal?  @db.Decimal(5, 4)
   payoutDate            DateTime?
   payoutReference       String?
   platformCommission    Decimal?  @db.Decimal(10, 2)
   realtorEarnings       Decimal?  @db.Decimal(10, 2)

   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt

   notifications  Notification[]
   booking        Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
   user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
   refundRequests RefundRequest[]

   @@map("payments")
}

model Review {
   id                  String          @id @default(cuid())
   bookingId           String          @unique
   propertyId          String
   authorId            String
   rating              Int
   comment             String?
   createdAt           DateTime        @default(now())
   accuracyRating      Int?
   checkInRating       Int?
   cleanlinessRating   Int?
   communicationRating Int?
   dislikesCount       Int             @default(0)
   helpfulCount        Int             @default(0)
   isVerified          Boolean         @default(false)
   isVisible           Boolean         @default(true)
   likesCount          Int             @default(0)
   locationRating      Int?
   updatedAt           DateTime        @default(now()) @updatedAt
   valueRating         Int?
   notifications       Notification[]
   photos              ReviewPhoto[]
   hostResponse        ReviewResponse?
   author              User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
   booking             Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
   property            Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)

   @@map("reviews")
}

model ReviewPhoto {
   id       String  @id @default(cuid())
   reviewId String
   url      String
   caption  String?
   order    Int     @default(0)
   review   Review  @relation(fields: [reviewId], references: [id], onDelete: Cascade)

   @@map("review_photos")
}

model ReviewResponse {
   id        String   @id @default(cuid())
   reviewId  String   @unique
   authorId  String
   comment   String
   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt
   author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
   review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)

   @@map("review_responses")
}

model Notification {
   id         String           @id @default(cuid())
   userId     String
   type       NotificationType
   title      String
   message    String
   data       Json?
   isRead     Boolean          @default(false)
   priority   String           @default("normal")
   bookingId  String?
   propertyId String?
   paymentId  String?
   reviewId   String?
   emailSent  Boolean          @default(false)
   pushSent   Boolean          @default(false)
   smsEnabled Boolean          @default(false)
   smsSent    Boolean          @default(false)
   createdAt  DateTime         @default(now())
   updatedAt  DateTime         @updatedAt
   expiresAt  DateTime?
   booking    Booking?         @relation(fields: [bookingId], references: [id])
   payment    Payment?         @relation(fields: [paymentId], references: [id])
   property   Property?        @relation(fields: [propertyId], references: [id])
   review     Review?          @relation(fields: [reviewId], references: [id])
   user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)

   @@map("notifications")
}

model AuditLog {
   id         String   @id @default(cuid())
   action     String
   entityType String
   entityId   String
   userId     String?
   adminId    String?
   ipAddress  String?
   userAgent  String?
   details    Json?
   timestamp  DateTime @default(now())
   createdAt  DateTime @default(now())
   admin      User?    @relation("AdminAuditLogs", fields: [adminId], references: [id])
   user       User?    @relation(fields: [userId], references: [id])

   @@index([action])
   @@index([entityType])
   @@index([entityId])
   @@index([userId])
   @@index([adminId])
   @@index([timestamp])
   @@map("audit_logs")
}

model NotificationPreference {
   id                  String   @id @default(cuid())
   userId              String   @unique
   emailEnabled        Boolean  @default(true)
   emailBookingUpdates Boolean  @default(true)
   emailPaymentUpdates Boolean  @default(true)
   emailReviews        Boolean  @default(true)
   emailMarketing      Boolean  @default(false)
   emailSystemAlerts   Boolean  @default(true)
   pushEnabled         Boolean  @default(true)
   pushBookingUpdates  Boolean  @default(true)
   pushPaymentUpdates  Boolean  @default(true)
   pushReviews         Boolean  @default(true)
   pushSystemAlerts    Boolean  @default(true)
   smsEnabled          Boolean  @default(false)
   smsBookingUpdates   Boolean  @default(false)
   smsPaymentUpdates   Boolean  @default(true)
   smsSystemAlerts     Boolean  @default(false)
   digestFrequency     String   @default("daily")
   quietHoursStart     String?  @default("22:00")
   quietHoursEnd       String?  @default("08:00")
   timezone            String   @default("UTC")
   createdAt           DateTime @default(now())
   updatedAt           DateTime @updatedAt
   user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

   @@map("notification_preferences")
}

model RefundRequest {
   id                 String              @id @default(cuid())
   bookingId          String
   paymentId          String
   requestedBy        String
   requestedAmount    Decimal             @db.Decimal(10, 2)
   currency           String
   reason             String
   customerNotes      String?
   status             RefundRequestStatus @default(PENDING_REALTOR_APPROVAL)
   realtorId          String?
   realtorApprovedAt  DateTime?
   realtorReason      String?
   realtorNotes       String?
   adminId            String?
   adminProcessedAt   DateTime?
   adminNotes         String?
   actualRefundAmount Decimal?            @db.Decimal(10, 2)
   providerRefundId   String?
   createdAt          DateTime            @default(now())
   updatedAt          DateTime            @updatedAt
   completedAt        DateTime?
   admin              User?               @relation("RefundAdmin", fields: [adminId], references: [id])
   booking            Booking             @relation(fields: [bookingId], references: [id], onDelete: Cascade)
   payment            Payment             @relation(fields: [paymentId], references: [id], onDelete: Cascade)
   realtor            Realtor?            @relation(fields: [realtorId], references: [id])
   requester          User                @relation("RefundRequester", fields: [requestedBy], references: [id], onDelete: Cascade)

   @@index([bookingId])
   @@index([paymentId])
   @@index([status])
   @@index([requestedBy])
   @@index([realtorId])
   @@map("refund_requests")
}

model PlatformSettings {
   key           String   @id
   value         Json
   description   String?
   category      String   @default("general")
   isActive      Boolean  @default(true)
   updatedBy     String
   createdAt     DateTime @default(now())
   updatedAt     DateTime @updatedAt
   updatedByUser User     @relation(fields: [updatedBy], references: [id])

   @@index([category])
   @@index([isActive])
   @@map("platform_settings")
}

model PendingRegistration {
   id                  String   @id @default(cuid())
   email               String   @unique
   firstName           String
   lastName            String
   role                UserRole @default(GUEST)
   referredByRealtorId String?
   referralSource      String?
   otp                 String
   otpExpires          DateTime
   createdAt           DateTime @default(now())
   updatedAt           DateTime @updatedAt

   @@index([email])
   @@index([otpExpires])
   @@map("pending_registrations")
}

model Dispute {
   id          String        @id @default(cuid())
   bookingId   String
   disputeType DisputeType
   status      DisputeStatus @default(OPEN)
   openedBy    String // userId
   openedAt    DateTime      @default(now())
   closedAt    DateTime?

   // Outcome
   outcome      String? // Description of resolution
   agreedAmount Decimal? @db.Decimal(10, 2) // If negotiated settlement

   // Evidence
   evidence Json? // Array of photo/video URLs with metadata

   // Conversation
   messages Json? // Array of dispute messages between parties

   // Admin escalation
   escalatedToAdmin Boolean   @default(false)
   adminId          String?
   adminNotes       String?
   adminResolvedAt  DateTime?

   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt

   booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
   opener  User    @relation("DisputeOpener", fields: [openedBy], references: [id])
   admin   User?   @relation("DisputeAdmin", fields: [adminId], references: [id])

   @@index([bookingId])
   @@index([status])
   @@index([disputeType])
   @@map("disputes")
}

model EscrowEvent {
   id        String          @id @default(cuid())
   bookingId String
   eventType EscrowEventType
   amount    Decimal         @db.Decimal(10, 2)
   currency  String          @default("NGN")

   // Money movement
   fromParty String? // "CUSTOMER" | "ESCROW" | "PLATFORM"
   toParty   String? // "REALTOR" | "CUSTOMER" | "PLATFORM" | "ESCROW"

   // Tracking
   executedAt           DateTime @default(now())
   transactionReference String?
   providerResponse     Json?

   // Context
   notes       String?
   triggeredBy String? // userId or "SYSTEM" for automated events

   booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

   @@index([bookingId])
   @@index([eventType])
   @@map("escrow_events")
}

enum UserRole {
   GUEST
   REALTOR
   ADMIN
}

enum PropertyType {
   APARTMENT
   HOUSE
   VILLA
   STUDIO
   TOWNHOUSE
   OTHER
}

enum PropertyStatus {
   DRAFT
   ACTIVE
   INACTIVE
}

enum BookingStatus {
   PENDING // Initial state, waiting for payment
   PAID // Payment confirmed, funds in escrow (deprecated - use CONFIRMED)
   CONFIRMED // Payment verified, cleaning fee released, awaiting check-in
   CHECKED_IN // User has checked in (1-hour guest dispute window active)
   CHECKED_IN_CONFIRMED // Check-in explicitly confirmed (timer started)
   DISPUTE_OPENED // Either user or realtor opened a dispute
   CHECKED_OUT // User has checked out (4-hour realtor dispute window active)
   COMPLETED // All funds released, booking finished
   CANCELLED // Booking cancelled before check-in
}

enum PayoutStatus {
   PENDING // Payment received, waiting for check-in
   READY // Check-in time reached, ready to transfer
   PROCESSING // Transfer initiated
   COMPLETED // Successfully paid out
   FAILED // Payout failed
}

enum RefundTier {
   EARLY // 24+ hours before check-in (90/7/3 split)
   MEDIUM // 12-24 hours before check-in (70/20/10 split)
   LATE // 0-12 hours before check-in (0/80/20 split)
   NONE // After check-in or no refund
}

enum PaymentStatus {
   INITIATED // Payment process started
   PENDING // Waiting for payment provider confirmation (deprecated)
   PARTIAL_RELEASED // Cleaning fee + service fee released, room fee + deposit in escrow
   ESCROW_HELD // Room fee + security deposit held in escrow (deprecated - use PARTIAL_RELEASED)
   ROOM_FEE_SPLIT_RELEASED // 90% to realtor, 10% to platform (after 1-hour dispute window)
   DEPOSIT_PROCESSING // Processing deposit refund or deduction
   RELEASED_TO_REALTOR // Full escrow released to realtor
   REFUNDED_TO_CUSTOMER // Full refund to customer
   PARTIAL_PAYOUT_REALTOR // Partial payout after dispute settlement
   COMPLETED // All transactions completed
   FAILED // Payment failed
}

enum PaymentMethod {
   PAYSTACK
   FLUTTERWAVE
}

enum RealtorStatus {
   PENDING
   APPROVED
   REJECTED
   SUSPENDED
}

enum CacStatus {
   PENDING
   APPROVED
   REJECTED
   SUSPENDED
}

enum NotificationType {
   BOOKING_CONFIRMED
   BOOKING_CANCELLED
   PAYMENT_COMPLETED
   PAYMENT_FAILED
   REVIEW_RECEIVED
   REVIEW_RESPONSE
   SYSTEM_ALERT
   PROPERTY_STATUS_CHANGE
   MESSAGE_RECEIVED
   CAC_STATUS_UPDATE
   BOOKING_REMINDER
   PAYMENT_REMINDER
   REALTOR_REGISTRATION
   CAC_VERIFICATION
   PAYOUT_COMPLETED
   PROPERTY_SUBMISSION
   REVIEW_FLAGGED
   DISPUTE_OPENED
   REALTOR_REINSTATED
}

enum RefundRequestStatus {
   PENDING_REALTOR_APPROVAL
   REALTOR_APPROVED
   REALTOR_REJECTED
   ADMIN_PROCESSING
   COMPLETED
   CANCELLED
}

enum DisputeType {
   USER_DISPUTE // Opened by user within 1 hour of check-in
   REALTOR_DISPUTE // Opened by realtor within 4 hours of check-out
}

enum DisputeStatus {
   OPEN // Dispute just opened, waiting for other party response
   AWAITING_RESPONSE // Waiting for counterparty to respond
   NEGOTIATION // Both parties are negotiating
   AGREED // Parties reached agreement
   ADMIN_REVIEW // Escalated to admin for resolution
   RESOLVED // Dispute resolved (by agreement or admin)
   REJECTED // Dispute rejected as invalid
}

enum DisputeTier {
   TIER_1_SEVERE // 100% room fee refund (realtor fault: no access, fake listing, uninhabitable)
   TIER_2_PARTIAL // 30% room fee refund (partial fault: broken AC, missing amenities)
   TIER_3_ABUSE // 0% refund (guest abuse: no evidence, late dispute, false claim)
}

enum CheckInConfirmationType {
   GUEST_CONFIRMED // Guest clicked "I've entered the room"
   REALTOR_CONFIRMED // Realtor confirmed guest checked in (after official check-in time)
   AUTO_FALLBACK // Automatic confirmation 30 minutes after official check-in time
}

enum RealtorDisputeOutcome {
   WIN // Realtor proved damage, gets deduction from deposit
   LOSS // No proof or invalid claim, full deposit refunded to guest
   PARTIAL // Partial damage proven, partial deduction
}

enum EscrowEventType {
   HOLD_ROOM_FEE // Room fee moved to escrow
   HOLD_SECURITY_DEPOSIT // Security deposit moved to escrow
   RELEASE_CLEANING_FEE // Immediate release of cleaning fee to realtor
   COLLECT_SERVICE_FEE // Immediate collection of service fee by platform
   RELEASE_ROOM_FEE_SPLIT // 90% to realtor, 10% to platform (after 1-hour window)
   RELEASE_DEPOSIT_TO_CUSTOMER // Security deposit returned to customer (after 4-hour window)
   PAY_REALTOR_FROM_DEPOSIT // Deduct from deposit, pay to realtor
   PAY_BALANCE_FROM_CUSTOMER // Customer pays additional amount from new payment
   REFUND_ROOM_FEE_TO_CUSTOMER // Refund room fee from escrow to customer
   REFUND_PARTIAL_TO_CUSTOMER // Partial refund to customer after dispute
   REFUND_PARTIAL_TO_REALTOR // Partial payout to realtor after dispute
}

model JobLock {
   id         String   @id @default(cuid())
   jobName    String   @unique
   lockedAt   DateTime @default(now())
   lockedBy   String // Instance ID or hostname
   expiresAt  DateTime
   bookingIds String[] // Bookings being processed

   @@index([jobName])
   @@index([expiresAt])
   @@map("job_locks")
}

model WebhookEvent {
   id          String   @id @default(cuid())
   provider    String // PAYSTACK or FLUTTERWAVE
   eventId     String   @unique // Webhook event ID from provider
   eventType   String // charge.success, transfer.success, etc.
   status      String // PROCESSED, FAILED, DUPLICATE
   payload     Json // Full webhook payload for debugging
   processedAt DateTime @default(now())
   metadata    Json? // Additional metadata (booking ID, payment ID, etc.)

   @@index([eventId])
   @@index([provider])
   @@index([processedAt])
   @@map("webhook_events")
}

model Message {
   id          String              @id @default(cuid())
   content     String              @db.Text
   type        MessageType         @default(BOOKING_MESSAGE)
   isRead      Boolean             @default(false)
   readAt      DateTime?
   createdAt   DateTime            @default(now())
   updatedAt   DateTime            @updatedAt
   // Context: property inquiry or booking conversation
   propertyId  String?
   bookingId   String?
   // Sender and recipient
   senderId    String
   recipientId String
   // Filtering metadata
   wasFiltered Boolean             @default(false)
   violations  String[]            @default([])
   // Relations
   property    Property?           @relation(fields: [propertyId], references: [id], onDelete: Cascade)
   booking     Booking?            @relation(fields: [bookingId], references: [id], onDelete: Cascade)
   sender      User                @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
   recipient   User                @relation("ReceivedMessages", fields: [recipientId], references: [id], onDelete: Cascade)
   attachments MessageAttachment[]

   @@index([propertyId])
   @@index([bookingId])
   @@index([senderId])
   @@index([recipientId])
   @@index([createdAt])
   @@index([isRead])
   @@map("messages")
}

model MessageAttachment {
   id        String   @id @default(cuid())
   messageId String
   url       String
   type      String // IMAGE, DOCUMENT
   filename  String
   size      Int
   createdAt DateTime @default(now())
   message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

   @@index([messageId])
   @@map("message_attachments")
}

model Favorite {
   id         String   @id @default(cuid())
   userId     String
   propertyId String
   createdAt  DateTime @default(now())

   user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
   property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

   @@unique([userId, propertyId]) // Prevent duplicate favorites
   @@index([userId])
   @@index([propertyId])
   @@map("favorites")
}

enum MessageType {
   INQUIRY // Pre-booking Q&A about property (limited)
   BOOKING_MESSAGE // Regular message within active booking (full messaging)
   SYSTEM // System-generated messages (check-in info, access codes, etc.)
}
