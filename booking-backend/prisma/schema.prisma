generator client {
   provider = "prisma-client-js"
}

datasource db {
   provider = "postgresql"
   url      = env("DATABASE_URL")
}

enum UserRole {
   GUEST
   REALTOR
   ADMIN
}

enum PropertyType {
   APARTMENT
   HOUSE
   VILLA
   STUDIO
   TOWNHOUSE
   OTHER
}

enum BookingStatus {
   PENDING
   CONFIRMED
   CANCELLED
   COMPLETED
}

enum PaymentStatus {
   PENDING
   COMPLETED
   FAILED
   REFUNDED
}

enum PaymentMethod {
   PAYSTACK
   FLUTTERWAVE
}

enum RealtorStatus {
   PENDING
   APPROVED
   REJECTED
   SUSPENDED
}

enum CacStatus {
   PENDING
   APPROVED
   REJECTED
   SUSPENDED
}

model User {
   id              String   @id @default(cuid())
   email           String   @unique
   businessEmail   String? // For realtors - their business email
   password        String
   fullName        String // Store full name as provided in registration
   firstName       String // Derived from fullName for backward compatibility
   lastName        String // Derived from fullName for backward compatibility
   role            UserRole @default(GUEST)
   phone           String?
   businessAddress String? // For realtors - their business address
   avatar          String?

   // Email verification fields
   isEmailVerified          Boolean   @default(false)
   emailVerificationToken   String?
   emailVerificationExpires DateTime?

   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt

   // Relations
   realtor                Realtor?
   bookings               Booking[]
   reviews                Review[]
   reviewResponses        ReviewResponse[]
   payments               Payment[]
   notifications          Notification[]
   notificationPreference NotificationPreference?
   auditLogs              AuditLog[]
   adminAuditLogs         AuditLog[]              @relation("AdminAuditLogs")
   refundRequests         RefundRequest[]         @relation("RefundRequester")
   adminRefundRequests    RefundRequest[]         @relation("RefundAdmin")
   platformSettings       PlatformSettings[]

   @@map("users")
}

model Realtor {
   id                 String        @id @default(cuid())
   userId             String        @unique
   businessName       String // Agency name from registration
   tagline            String? // Business tagline/description
   description        String? // Business description (optional)
   slug               String        @unique // Custom subdomain
   corporateRegNumber String? // Business registration number (CAC)
   cacDocumentUrl     String? // CAC Document upload URL (optional)
   logoUrl            String? // Logo upload URL
   businessPhone      String? // Business phone number
   status             RealtorStatus @default(PENDING) // Approval status

   // CAC verification fields
   cacStatus           CacStatus @default(PENDING) // CAC verification status
   cacVerifiedAt       DateTime? // When CAC was approved
   cacRejectedAt       DateTime? // When CAC was rejected
   cacRejectionReason  String? // Reason for CAC rejection
   suspendedAt         DateTime? // When account was suspended
   suspensionExpiresAt DateTime? // When account will be deleted if no appeal
   canAppeal           Boolean   @default(true) // Can appeal CAC rejection

   // Branding colors from registration
   primaryColor   String  @default("#000000") // Default to black as per requirements
   secondaryColor String? @default("#10B981")
   accentColor    String? @default("#F59E0B")

   // Social media profiles from registration
   websiteUrl   String?
   instagramUrl String?
   twitterUrl   String?
   linkedinUrl  String?
   facebookUrl  String?
   youtubeUrl   String?
   whatsappType String? @default("business") // "personal" or "business"

   // Payment integration
   paystackSubAccountCode String? // Paystack subaccount for split payments

   isActive  Boolean  @default(true)
   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt

   // Relations
   user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
   properties     Property[]
   refundRequests RefundRequest[]

   @@map("realtors")
}

model Property {
   id              String       @id @default(cuid())
   realtorId       String
   title           String
   description     String
   type            PropertyType
   pricePerNight   Decimal      @db.Decimal(10, 2)
   currency        String       @default("NGN")
   maxGuests       Int
   bedrooms        Int
   bathrooms       Int
   address         String
   city            String
   state           String?
   country         String
   amenities       String[]     @default([])
   customAmenities String[]     @default([])
   isActive        Boolean      @default(true)
   createdAt       DateTime     @default(now())
   updatedAt       DateTime     @updatedAt

   // Relations
   realtor       Realtor         @relation(fields: [realtorId], references: [id], onDelete: Cascade)
   bookings      Booking[]
   reviews       Review[]
   images        PropertyImage[]
   notifications Notification[]

   @@map("properties")
}

model PropertyImage {
   id         String @id @default(cuid())
   propertyId String
   url        String
   order      Int    @default(0)

   property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

   @@map("property_images")
}

model Booking {
   id           String        @id @default(cuid())
   propertyId   String
   guestId      String
   checkInDate  DateTime
   checkOutDate DateTime
   totalGuests  Int
   totalPrice   Decimal       @db.Decimal(10, 2)
   currency     String        @default("NGN")
   status       BookingStatus @default(PENDING)
   createdAt    DateTime      @default(now())
   updatedAt    DateTime      @updatedAt

   // Relations
   property       Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
   guest          User            @relation(fields: [guestId], references: [id], onDelete: Cascade)
   payment        Payment?
   review         Review?
   notifications  Notification[]
   refundRequests RefundRequest[]

   @@map("bookings")
}

model Payment {
   id                    String        @id @default(cuid())
   bookingId             String        @unique
   userId                String
   amount                Decimal       @db.Decimal(10, 2)
   currency              String        @default("NGN")
   status                PaymentStatus @default(PENDING)
   method                PaymentMethod
   reference             String?       @unique // paystack/flutterwave ref
   providerTransactionId String? // transaction ID from payment provider
   paidAt                DateTime? // when payment was completed
   refundAmount          Decimal?      @db.Decimal(10, 2) // amount refunded if any
   refundedAt            DateTime? // when refund was processed
   metadata              Json? // store additional payment provider data

   // Commission tracking
   platformCommission Decimal?  @db.Decimal(10, 2) // Platform fee (e.g., 5%)
   commissionRate     Decimal?  @db.Decimal(5, 4) // Commission rate as decimal (0.05 = 5%)
   realtorEarnings    Decimal?  @db.Decimal(10, 2) // Amount realtor receives after commission
   commissionPaidOut  Boolean   @default(false) // Whether commission has been settled
   payoutDate         DateTime? // When realtor was paid
   payoutReference    String? // Payout transaction reference

   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt

   // Relations
   booking        Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
   user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
   notifications  Notification[]
   refundRequests RefundRequest[]

   @@map("payments")
}

model Review {
   id         String  @id @default(cuid())
   bookingId  String  @unique
   propertyId String
   authorId   String
   rating     Int
   comment    String?

   // Detailed rating breakdowns
   cleanlinessRating   Int?
   communicationRating Int?
   checkInRating       Int?
   accuracyRating      Int?
   locationRating      Int?
   valueRating         Int?

   // Photo uploads
   photos ReviewPhoto[]

   // Review management
   isVisible  Boolean @default(true)
   isVerified Boolean @default(false) // Verified if booking was completed

   // Engagement metrics
   helpfulCount  Int @default(0)
   likesCount    Int @default(0)
   dislikesCount Int @default(0)

   // Timestamps
   createdAt DateTime @default(now())
   updatedAt DateTime @default(now()) @updatedAt

   // Host response
   hostResponse ReviewResponse?

   // Relations
   booking       Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)
   property      Property       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
   author        User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
   notifications Notification[]

   @@map("reviews")
}

model ReviewPhoto {
   id       String  @id @default(cuid())
   reviewId String
   url      String
   caption  String?
   order    Int     @default(0)

   review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

   @@map("review_photos")
}

model ReviewResponse {
   id        String   @id @default(cuid())
   reviewId  String   @unique
   authorId  String // Realtor who responded
   comment   String
   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt

   review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
   author User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

   @@map("review_responses")
}

enum NotificationType {
   BOOKING_CONFIRMED
   BOOKING_CANCELLED
   PAYMENT_COMPLETED
   PAYMENT_FAILED
   REVIEW_RECEIVED
   REVIEW_RESPONSE
   SYSTEM_ALERT
   PROPERTY_STATUS_CHANGE
   MESSAGE_RECEIVED
   CAC_STATUS_UPDATE
   BOOKING_REMINDER
   PAYMENT_REMINDER
   REALTOR_REGISTRATION
   CAC_VERIFICATION
   PAYOUT_COMPLETED
   PROPERTY_SUBMISSION
   REVIEW_FLAGGED
   DISPUTE_OPENED
   REALTOR_REINSTATED
}

model Notification {
   id      String           @id @default(cuid())
   userId  String
   type    NotificationType
   title   String
   message String
   data    Json? // Additional metadata

   // Status
   isRead   Boolean @default(false)
   priority String  @default("normal") // "low", "normal", "high", "urgent"

   // Optional references
   bookingId  String?
   propertyId String?
   paymentId  String?
   reviewId   String?

   // Delivery settings
   emailSent  Boolean @default(false)
   pushSent   Boolean @default(false)
   smsEnabled Boolean @default(false)
   smsSent    Boolean @default(false)

   createdAt DateTime  @default(now())
   updatedAt DateTime  @updatedAt
   expiresAt DateTime? // Optional expiration for temporary notifications

   // Relations
   user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
   booking  Booking?  @relation(fields: [bookingId], references: [id], onDelete: SetNull)
   property Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
   payment  Payment?  @relation(fields: [paymentId], references: [id], onDelete: SetNull)
   review   Review?   @relation(fields: [reviewId], references: [id], onDelete: SetNull)

   @@map("notifications")
}

model AuditLog {
   id         String   @id @default(cuid())
   action     String // Action performed (e.g., "REALTOR_APPROVED", "PAYMENT_PROCESSED")
   entityType String // Entity type (e.g., "REALTOR", "PAYMENT", "BOOKING")
   entityId   String // ID of the affected entity
   userId     String? // ID of the user who performed the action (null for system actions)
   adminId    String? // ID of admin who performed the action
   ipAddress  String? // IP address of the user
   userAgent  String? // User agent string
   details    Json? // Additional details about the action
   timestamp  DateTime @default(now())
   createdAt  DateTime @default(now())

   // Relations
   user  User? @relation(fields: [userId], references: [id], onDelete: SetNull)
   admin User? @relation("AdminAuditLogs", fields: [adminId], references: [id], onDelete: SetNull)

   @@index([action])
   @@index([entityType])
   @@index([entityId])
   @@index([userId])
   @@index([adminId])
   @@index([timestamp])
   @@map("audit_logs")
}

model NotificationPreference {
   id     String @id @default(cuid())
   userId String @unique

   // Email preferences
   emailEnabled        Boolean @default(true)
   emailBookingUpdates Boolean @default(true)
   emailPaymentUpdates Boolean @default(true)
   emailReviews        Boolean @default(true)
   emailMarketing      Boolean @default(false)
   emailSystemAlerts   Boolean @default(true)

   // Push notification preferences
   pushEnabled        Boolean @default(true)
   pushBookingUpdates Boolean @default(true)
   pushPaymentUpdates Boolean @default(true)
   pushReviews        Boolean @default(true)
   pushSystemAlerts   Boolean @default(true)

   // SMS preferences
   smsEnabled        Boolean @default(false)
   smsBookingUpdates Boolean @default(false)
   smsPaymentUpdates Boolean @default(true)
   smsSystemAlerts   Boolean @default(false)

   // Frequency settings
   digestFrequency String  @default("daily") // "immediate", "hourly", "daily", "weekly"
   quietHoursStart String? @default("22:00")
   quietHoursEnd   String? @default("08:00")
   timezone        String  @default("UTC")

   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt

   user User @relation(fields: [userId], references: [id], onDelete: Cascade)

   @@map("notification_preferences")
}

enum RefundRequestStatus {
   PENDING_REALTOR_APPROVAL
   REALTOR_APPROVED
   REALTOR_REJECTED
   ADMIN_PROCESSING
   COMPLETED
   CANCELLED
}

model RefundRequest {
   id              String  @id @default(cuid())
   bookingId       String
   paymentId       String
   requestedBy     String // Guest who requested refund
   requestedAmount Decimal @db.Decimal(10, 2)
   currency        String
   reason          String
   customerNotes   String? // Additional notes from customer

   // Realtor stage
   status            RefundRequestStatus @default(PENDING_REALTOR_APPROVAL)
   realtorId         String?
   realtorApprovedAt DateTime?
   realtorReason     String? // Realtor's reason for approval/rejection
   realtorNotes      String? // Additional realtor notes

   // Admin stage  
   adminId            String?
   adminProcessedAt   DateTime?
   adminNotes         String? // Admin notes during processing
   actualRefundAmount Decimal?  @db.Decimal(10, 2) // Final refunded amount
   providerRefundId   String? // Reference from payment provider

   // Timestamps
   createdAt   DateTime  @default(now())
   updatedAt   DateTime  @updatedAt
   completedAt DateTime?

   // Relations
   booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
   payment   Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
   requester User     @relation("RefundRequester", fields: [requestedBy], references: [id], onDelete: Cascade)
   realtor   Realtor? @relation(fields: [realtorId], references: [id], onDelete: SetNull)
   admin     User?    @relation("RefundAdmin", fields: [adminId], references: [id], onDelete: SetNull)

   @@index([bookingId])
   @@index([paymentId])
   @@index([status])
   @@index([requestedBy])
   @@index([realtorId])
   @@map("refund_requests")
}

model PlatformSettings {
   key         String   @id // e.g., "commission_rate", "payout_threshold", "email_template_welcome"
   value       Json // Store as JSON for flexibility (numbers, strings, objects, arrays)
   description String? // Human-readable description of the setting
   category    String   @default("general") // "commission", "payout", "email", "notification", "security"
   isActive    Boolean  @default(true) // Allow disabling settings without deletion
   updatedBy   String // Admin who last updated this setting
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt

   // Relations
   updatedByUser User @relation(fields: [updatedBy], references: [id])

   @@index([category])
   @@index([isActive])
   @@map("platform_settings")
}
