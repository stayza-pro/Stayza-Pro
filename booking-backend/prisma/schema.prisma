generator client {
   provider = "prisma-client-js"
}

datasource db {
   provider = "postgresql"
   url      = env("DATABASE_URL")
}

model User {
   id        String   @id @default(cuid())
   email     String   @unique
   password  String
   firstName String
   lastName  String
   role      UserRole @default(GUEST)
   phone     String?

   avatar                   String?
   createdAt                DateTime                @default(now())
   updatedAt                DateTime                @updatedAt
   businessAddress          String?
   businessEmail            String?
   fullName                 String
   emailVerificationExpires DateTime?
   emailVerificationToken   String?
   isEmailVerified          Boolean                 @default(false)
   referralSource           String?
   referredByRealtorId      String?
   adminAuditLogs           AuditLog[]              @relation("AdminAuditLogs")
   auditLogs                AuditLog[]
   bookings                 Booking[]
   notificationPreference   NotificationPreference?
   notifications            Notification[]
   payments                 Payment[]
   platformSettings         PlatformSettings[]
   realtor                  Realtor?
   adminRefundRequests      RefundRequest[]         @relation("RefundAdmin")
   refundRequests           RefundRequest[]         @relation("RefundRequester")
   reviewResponses          ReviewResponse[]
   reviews                  Review[]
   referredByRealtor        Realtor?                @relation("ReferredGuests", fields: [referredByRealtorId], references: [id])
   openedDisputes           Dispute[]               @relation("DisputeOpener")
   respondedDisputes        Dispute[]               @relation("DisputeResponder")
   adminDisputes            Dispute[]               @relation("DisputeAdmin")
   sentMessages             Message[]               @relation("SentMessages")
   receivedMessages         Message[]               @relation("ReceivedMessages")
   favorites                Favorite[]
   helpfulReviews           ReviewHelpful[]

   @@map("users")
}

model Realtor {
   id                 String   @id @default(cuid())
   userId             String   @unique
   businessName       String
   slug               String   @unique
   logoUrl            String?
   isActive           Boolean  @default(true)
   createdAt          DateTime @default(now())
   updatedAt          DateTime @updatedAt
   accentColor        String?  @default("#F59E0B")
   corporateRegNumber String?
   primaryColor       String   @default("#3B82F6")
   secondaryColor     String?  @default("#1E40AF")
   tagline            String?
   websiteUrl         String?

   cacDocumentUrl                String?
   description                   String?
   status                        RealtorStatus       @default(PENDING)
   cacRejectedAt                 DateTime?
   cacRejectionReason            String?
   cacStatus                     CacStatus           @default(PENDING)
   cacVerifiedAt                 DateTime?
   canAppeal                     Boolean             @default(true)
   suspendedAt                   DateTime?
   suspensionExpiresAt           DateTime?
   paystackSubAccountCode        String?
   paystackTransferRecipientCode String?
   payoutBankCode                String?
   payoutBankName                String?
   payoutAccountNumber           String?
   payoutAccountName             String?
   flutterwaveSubAccountCode     String?
   averageRating                 Decimal?            @default(0) @db.Decimal(3, 2)
   reviewCount                   Int                 @default(0)
   properties                    Property[]
   user                          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
   refundRequests                RefundRequest[]
   referredGuests                User[]              @relation("ReferredGuests")
   withdrawalRequests            WithdrawalRequest[]

   @@map("realtors")
}

model Property {
   id                  String          @id @default(cuid())
   realtorId           String
   title               String
   description         String
   type                PropertyType
   pricePerNight       Decimal         @db.Decimal(10, 2)
   currency            String          @default("NGN")
   maxGuests           Int
   bedrooms            Int
   bathrooms           Int
   address             String
   city                String
   country             String
   isActive            Boolean         @default(true)
   createdAt           DateTime        @default(now())
   updatedAt           DateTime        @updatedAt
   amenities           String[]        @default([])
   customAmenities     String[]        @default([])
   state               String?
   status              PropertyStatus  @default(DRAFT)
   averageRating       Decimal?        @default(0) @db.Decimal(3, 2)
   reviewCount         Int             @default(0)
   cleanlinessRating   Decimal?        @default(0) @db.Decimal(3, 2)
   communicationRating Decimal?        @default(0) @db.Decimal(3, 2)
   checkInRating       Decimal?        @default(0) @db.Decimal(3, 2)
   accuracyRating      Decimal?        @default(0) @db.Decimal(3, 2)
   locationRating      Decimal?        @default(0) @db.Decimal(3, 2)
   valueRating         Decimal?        @default(0) @db.Decimal(3, 2)
   // Optional fees set by realtor
   serviceFee          Decimal?        @db.Decimal(10, 2)
   cleaningFee         Decimal?        @db.Decimal(10, 2)
   securityDeposit     Decimal?        @db.Decimal(10, 2)
   // Check-in/out and access information
   checkInTime         String?
   checkOutTime        String?
   accessInstructions  String?         @db.Text
   houseRules          String?         @db.Text
   wifiName            String?
   wifiPassword        String?
   parkingInstructions String?         @db.Text
   bookings            Booking[]
   notifications       Notification[]
   realtor             Realtor         @relation(fields: [realtorId], references: [id], onDelete: Cascade)
   images              PropertyImage[]
   reviews             Review[]
   messages            Message[]
   favorites           Favorite[]

   @@map("properties")
}

model PropertyImage {
   id         String   @id @default(cuid())
   propertyId String
   url        String
   order      Int      @default(0)
   property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

   @@map("property_images")
}

model Booking {
   id            String         @id @default(cuid())
   propertyId    String
   guestId       String
   checkInDate   DateTime
   checkOutDate  DateTime
   checkInTime   DateTime? // Actual check-in timestamp
   checkOutTime  DateTime? // Actual check-out timestamp
   totalGuests   Int
   totalPrice    Decimal        @db.Decimal(10, 2)
   currency      String         @default("NGN")
   status        BookingStatus  @default(PENDING)
   stayStatus    StayStatus     @default(NOT_STARTED) // Physical stay state
   paymentStatus PaymentStatus? @default(INITIATED) // Track payment status directly in booking

   // Fee breakdown (for transparency)
   roomFee         Decimal @default(0) @db.Decimal(10, 2)
   cleaningFee     Decimal @default(0) @db.Decimal(10, 2)
   securityDeposit Decimal @default(0) @db.Decimal(10, 2)
   serviceFee      Decimal @default(0) @db.Decimal(10, 2) // 2% of (roomFee + cleaningFee)
   platformFee     Decimal @default(0) @db.Decimal(10, 2) // 10% of roomFee (deducted at release)

   // Financial Engine V2 snapshot fields
   commissionBaseRate            Decimal? @db.Decimal(5, 4)
   commissionVolumeReductionRate Decimal? @db.Decimal(5, 4)
   commissionEffectiveRate       Decimal? @db.Decimal(5, 4)
   monthlyVolumeAtPricing        Decimal? @db.Decimal(12, 2)
   serviceFeeStayza              Decimal? @db.Decimal(10, 2)
   serviceFeeProcessing          Decimal? @db.Decimal(10, 2)
   processingFeeMode             String?

   // New commission flow fields
   checkinConfirmedAt       DateTime? // Timestamp when check-in was confirmed
   checkinConfirmationType  String? // "GUEST_CONFIRMED" | "REALTOR_CONFIRMED" | "AUTO_FALLBACK"
   roomFeeReleaseEligibleAt DateTime? // 1 hour after check-in confirmation
   depositRefundEligibleAt  DateTime? // 2 hours after check-out
   cleaningFeeReleasedAt    DateTime? // Immediate release timestamp
   serviceFeeCollectedAt    DateTime? // Immediate collection timestamp
   guestDisputeTier         String? // "TIER_1_SEVERE" | "TIER_2_PARTIAL" | "TIER_3_ABUSE"
   realtorDisputeOutcome    String? // "WIN" | "LOSS" | "PARTIAL"
   disputeRefundAmount      Decimal?  @db.Decimal(10, 2) // Calculated refund based on tier
   depositDeductionAmount   Decimal?  @db.Decimal(10, 2) // Amount deducted from deposit for damages

   // Dispute timers
   disputeWindowClosesAt  DateTime? // 1 hour after check-in
   realtorDisputeClosesAt DateTime? // 4 hours after checkout (updated from 2 hours)
   userDisputeOpened      Boolean   @default(false)
   realtorDisputeOpened   Boolean   @default(false)

   // Legacy fields (keeping for compatibility)
   refundCutoffTime  DateTime?
   payoutEligibleAt  DateTime?
   payoutStatus      PayoutStatus @default(PENDING)
   payoutCompletedAt DateTime?
   refundTier        RefundTier?
   specialRequests   String?

   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt

   guest          User            @relation(fields: [guestId], references: [id], onDelete: Cascade)
   property       Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
   notifications  Notification[]
   payment        Payment?
   refundRequests RefundRequest[]
   review         Review?
   disputes       Dispute[]
   escrowEvents   EscrowEvent[]
   messages       Message[]
   escrow         Escrow?

   @@map("bookings")
}

model Payment {
   id         String        @id @default(cuid())
   bookingId  String        @unique
   userId     String
   amount     Decimal       @db.Decimal(10, 2)
   currency   String        @default("NGN")
   status     PaymentStatus @default(INITIATED)
   method     PaymentMethod
   reference  String?       @unique
   providerId String? // "PAYSTACK" or "FLUTTERWAVE"

   // Payment breakdown
   roomFeeAmount         Decimal @default(0) @db.Decimal(10, 2)
   cleaningFeeAmount     Decimal @default(0) @db.Decimal(10, 2)
   securityDepositAmount Decimal @default(0) @db.Decimal(10, 2)
   serviceFeeAmount      Decimal @default(0) @db.Decimal(10, 2)
   platformFeeAmount     Decimal @default(0) @db.Decimal(10, 2)

   // Financial Engine V2 snapshot fields
   commissionBaseRate                 Decimal? @db.Decimal(5, 4)
   commissionVolumeReductionRate      Decimal? @db.Decimal(5, 4)
   commissionEffectiveRate            Decimal? @db.Decimal(5, 4)
   commissionBaseAmount               Decimal? @db.Decimal(10, 2)
   serviceFeeStayzaAmount             Decimal? @db.Decimal(10, 2)
   serviceFeeProcessingQuotedAmount   Decimal? @db.Decimal(10, 2)
   serviceFeeProcessingActualAmount   Decimal? @db.Decimal(10, 2)
   serviceFeeProcessingVarianceAmount Decimal? @db.Decimal(10, 2)
   processingFeeModeQuoted            String?
   processingFeeModeActual            String?

   // Escrow tracking
   roomFeeInEscrow   Boolean   @default(false)
   depositInEscrow   Boolean   @default(false)
   roomFeeReleasedAt DateTime?
   depositReleasedAt DateTime?

   // Payout tracking
   cleaningFeePaidOut  Boolean @default(false)
   serviceFeeCollected Boolean @default(false)
   roomFeeSplitDone    Boolean @default(false)
   depositRefunded     Boolean @default(false)

   // New commission flow tracking
   cleaningFeeReleasedToRealtor  Boolean  @default(false)
   cleaningFeeReleaseReference   String? // Payment gateway reference for cleaning fee release
   serviceFeeCollectedByPlatform Boolean  @default(false)
   roomFeeSplitRealtorAmount     Decimal? @db.Decimal(10, 2) // 90% of room fee
   roomFeeSplitPlatformAmount    Decimal? @db.Decimal(10, 2) // 10% of room fee
   roomFeeSplitReleaseReference  String? // Payment gateway reference for room fee split
   disputeRefundProcessed        Boolean  @default(false)
   disputeRefundReference        String? // Payment gateway reference for dispute refund
   depositDeductionProcessed     Boolean  @default(false)
   depositPartialRefundAmount    Decimal? @db.Decimal(10, 2) // Remaining deposit after deduction
   depositPartialRefundReference String? // Payment gateway reference for partial deposit refund

   // Manual payout tracking
   realtorTransferInitiated DateTime? // When realtor initiated manual payout
   realtorTransferCompleted DateTime? // When payout was completed
   realtorTransferReference String? // Payment gateway reference for realtor payout
   transferFailed           Boolean   @default(false) // Whether transfer failed

   // Legacy fields
   metadata              Json?
   paidAt                DateTime?
   refundAmount          Decimal?  @db.Decimal(10, 2)
   providerTransactionId String?
   refundedAt            DateTime?
   commissionPaidOut     Boolean   @default(false)
   commissionRate        Decimal?  @db.Decimal(5, 4)
   payoutDate            DateTime?
   payoutReference       String?
   platformCommission    Decimal?  @db.Decimal(10, 2)
   realtorEarnings       Decimal?  @db.Decimal(10, 2)

   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt

   notifications  Notification[]
   booking        Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
   user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
   refundRequests RefundRequest[]

   @@map("payments")
}

model Review {
   id                  String          @id @default(cuid())
   bookingId           String          @unique
   propertyId          String
   authorId            String
   rating              Int
   comment             String?
   createdAt           DateTime        @default(now())
   accuracyRating      Int?
   checkInRating       Int?
   cleanlinessRating   Int?
   communicationRating Int?
   dislikesCount       Int             @default(0)
   helpfulCount        Int             @default(0)
   isVerified          Boolean         @default(false)
   isVisible           Boolean         @default(true)
   likesCount          Int             @default(0)
   locationRating      Int?
   updatedAt           DateTime        @default(now()) @updatedAt
   valueRating         Int?
   notifications       Notification[]
   photos              ReviewPhoto[]
   hostResponse        ReviewResponse?
   helpfulMarks        ReviewHelpful[]
   author              User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
   booking             Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
   property            Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)

   @@map("reviews")
}

model ReviewPhoto {
   id       String  @id @default(cuid())
   reviewId String
   url      String
   caption  String?
   order    Int     @default(0)
   review   Review  @relation(fields: [reviewId], references: [id], onDelete: Cascade)

   @@map("review_photos")
}

model ReviewResponse {
   id        String   @id @default(cuid())
   reviewId  String   @unique
   authorId  String
   comment   String
   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt
   author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
   review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)

   @@map("review_responses")
}

model ReviewHelpful {
   id        String   @id @default(cuid())
   reviewId  String
   userId    String
   createdAt DateTime @default(now())
   review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
   user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

   @@unique([reviewId, userId])
   @@map("review_helpful")
}

model Notification {
   id         String           @id @default(cuid())
   userId     String
   type       NotificationType
   title      String
   message    String
   data       Json?
   isRead     Boolean          @default(false)
   priority   String           @default("normal")
   bookingId  String?
   propertyId String?
   paymentId  String?
   reviewId   String?
   emailSent  Boolean          @default(false)
   pushSent   Boolean          @default(false)
   smsEnabled Boolean          @default(false)
   smsSent    Boolean          @default(false)
   createdAt  DateTime         @default(now())
   updatedAt  DateTime         @updatedAt
   expiresAt  DateTime?
   booking    Booking?         @relation(fields: [bookingId], references: [id])
   payment    Payment?         @relation(fields: [paymentId], references: [id])
   property   Property?        @relation(fields: [propertyId], references: [id])
   review     Review?          @relation(fields: [reviewId], references: [id])
   user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)

   @@map("notifications")
}

model AuditLog {
   id         String   @id @default(cuid())
   action     String
   entityType String
   entityId   String
   userId     String?
   adminId    String?
   ipAddress  String?
   userAgent  String?
   details    Json?
   timestamp  DateTime @default(now())
   createdAt  DateTime @default(now())
   admin      User?    @relation("AdminAuditLogs", fields: [adminId], references: [id])
   user       User?    @relation(fields: [userId], references: [id])

   @@index([action])
   @@index([entityType])
   @@index([entityId])
   @@index([userId])
   @@index([adminId])
   @@index([timestamp])
   @@map("audit_logs")
}

model NotificationPreference {
   id                  String   @id @default(cuid())
   userId              String   @unique
   emailEnabled        Boolean  @default(true)
   emailBookingUpdates Boolean  @default(true)
   emailPaymentUpdates Boolean  @default(true)
   emailReviews        Boolean  @default(true)
   emailMarketing      Boolean  @default(false)
   emailSystemAlerts   Boolean  @default(true)
   pushEnabled         Boolean  @default(true)
   pushBookingUpdates  Boolean  @default(true)
   pushPaymentUpdates  Boolean  @default(true)
   pushReviews         Boolean  @default(true)
   pushSystemAlerts    Boolean  @default(true)
   smsEnabled          Boolean  @default(false)
   smsBookingUpdates   Boolean  @default(false)
   smsPaymentUpdates   Boolean  @default(true)
   smsSystemAlerts     Boolean  @default(false)
   digestFrequency     String   @default("daily")
   quietHoursStart     String?  @default("22:00")
   quietHoursEnd       String?  @default("08:00")
   timezone            String   @default("UTC")
   createdAt           DateTime @default(now())
   updatedAt           DateTime @updatedAt
   user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

   @@map("notification_preferences")
}

model RefundRequest {
   id                 String              @id @default(cuid())
   bookingId          String
   paymentId          String
   requestedBy        String
   requestedAmount    Decimal             @db.Decimal(10, 2)
   currency           String
   reason             String
   customerNotes      String?
   status             RefundRequestStatus @default(PENDING_REALTOR_APPROVAL)
   realtorId          String?
   realtorApprovedAt  DateTime?
   realtorReason      String?
   realtorNotes       String?
   adminId            String?
   adminProcessedAt   DateTime?
   adminNotes         String?
   actualRefundAmount Decimal?            @db.Decimal(10, 2)
   providerRefundId   String?
   createdAt          DateTime            @default(now())
   updatedAt          DateTime            @updatedAt
   completedAt        DateTime?
   admin              User?               @relation("RefundAdmin", fields: [adminId], references: [id])
   booking            Booking             @relation(fields: [bookingId], references: [id], onDelete: Cascade)
   payment            Payment             @relation(fields: [paymentId], references: [id], onDelete: Cascade)
   realtor            Realtor?            @relation(fields: [realtorId], references: [id])
   requester          User                @relation("RefundRequester", fields: [requestedBy], references: [id], onDelete: Cascade)

   @@index([bookingId])
   @@index([paymentId])
   @@index([status])
   @@index([requestedBy])
   @@index([realtorId])
   @@map("refund_requests")
}

model PlatformSettings {
   key           String   @id
   value         Json
   description   String?
   category      String   @default("general")
   isActive      Boolean  @default(true)
   updatedBy     String
   createdAt     DateTime @default(now())
   updatedAt     DateTime @updatedAt
   updatedByUser User     @relation(fields: [updatedBy], references: [id])

   @@index([category])
   @@index([isActive])
   @@map("platform_settings")
}

model PendingRegistration {
   id                  String   @id @default(cuid())
   email               String   @unique
   firstName           String
   lastName            String
   phone               String?
   role                UserRole @default(GUEST)
   referredByRealtorId String?
   referralSource      String?
   otp                 String
   otpExpires          DateTime
   createdAt           DateTime @default(now())
   updatedAt           DateTime @updatedAt

   @@index([email])
   @@index([otpExpires])
   @@map("pending_registrations")
}

model Dispute {
   id                  String                 @id @default(cuid())
   bookingId           String
   disputeSubject      DisputeSubject // ROOM_FEE or SECURITY_DEPOSIT
   category            DisputeCategory
   status              DisputeStatus          @default(OPEN)
   openedBy            String // userId (guest or realtor)
   openedAt            DateTime               @default(now())
   closedAt            DateTime?
   // Auto-calculated refund/claim amounts
   maxRefundPercent    Int // 0, 30, or 100 based on category
   claimedAmount       Decimal                @db.Decimal(10, 2) // Amount being disputed
   guestRefundAmount   Decimal                @db.Decimal(10, 2) // What guest would get
   realtorPayoutAmount Decimal                @db.Decimal(10, 2) // What realtor would get
   platformFeeAmount   Decimal                @db.Decimal(10, 2) // What platform would get
   // Evidence and details
   writeup             String                 @db.Text
   attachments         Json? // Array of photo/video URLs
   // Realtor/Guest response
   respondedBy         String? // userId of responder
   respondedAt         DateTime?
   responseAction      DisputeResponseAction? // ACCEPT or REJECT_ESCALATE
   responseNotes       String?                @db.Text
   // Admin resolution (if escalated)
   escalatedToAdmin    Boolean                @default(false)
   adminId             String?
   adminDecision       AdminDisputeDecision?
   adminNotes          String?                @db.Text
   adminResolvedAt     DateTime?
   adminDeadlineAt     DateTime? // SLA deadline (48h from escalation)
   // Final outcome
   finalOutcome        DisputeFinalOutcome?
   tier                DisputeTier? // Severity tier (set during resolution)
   executedAt          DateTime?
   executionReference  String? // Reference to escrow/wallet transactions
   createdAt           DateTime               @default(now())
   updatedAt           DateTime               @updatedAt

   booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
   opener    User    @relation("DisputeOpener", fields: [openedBy], references: [id])
   responder User?   @relation("DisputeResponder", fields: [respondedBy], references: [id])
   admin     User?   @relation("DisputeAdmin", fields: [adminId], references: [id])

   @@index([bookingId])
   @@index([status])
   @@index([disputeSubject])
   @@index([category])
   @@map("disputes")
}

model EscrowEvent {
   id        String          @id @default(cuid())
   bookingId String
   eventType EscrowEventType
   amount    Decimal         @db.Decimal(10, 2)
   currency  String          @default("NGN")

   // Money movement
   fromParty String? // "CUSTOMER" | "ESCROW" | "PLATFORM"
   toParty   String? // "REALTOR" | "CUSTOMER" | "PLATFORM" | "ESCROW"

   // Tracking
   executedAt           DateTime @default(now())
   transactionReference String?
   providerResponse     Json?

   // Context
   notes       String?
   triggeredBy String? // userId or "SYSTEM" for automated events

   booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

   @@index([bookingId])
   @@index([eventType])
   @@map("escrow_events")
}

enum UserRole {
   GUEST
   REALTOR
   ADMIN
}

enum PropertyType {
   APARTMENT
   HOUSE
   VILLA
   STUDIO
   TOWNHOUSE
   OTHER
}

enum PropertyStatus {
   DRAFT
   ACTIVE
   INACTIVE
}

enum BookingStatus {
   PENDING // Created, not paid
   ACTIVE // Paid, not cancelled
   DISPUTED // Has active dispute
   COMPLETED // Fully settled
   CANCELLED // Cancelled before completion
}

enum StayStatus {
   NOT_STARTED // Guest has not checked in yet
   CHECKED_IN // Guest is currently staying
   CHECKED_OUT // Guest has checked out
}

enum DisputeStatus {
   OPEN // Dispute opened, waiting for response
   AWAITING_RESPONSE // One party responded, waiting for other
   ESCALATED // Escalated to admin
   RESOLVED // Dispute resolved
   CANCELLED // Dispute cancelled
}

enum PayoutStatus {
   PENDING // Payment received, waiting for check-in
   READY // Check-in time reached, ready to transfer
   PROCESSING // Transfer initiated
   COMPLETED // Successfully paid out
   FAILED // Payout failed
}

enum RefundTier {
   EARLY // 24+ hours before check-in (90% customer / 7% realtor / 3% platform)
   MEDIUM // 12-24 hours before check-in (70% customer / 20% realtor / 10% platform)
   LATE // 0-12 hours before check-in (0% customer / 80% realtor / 20% platform)
   NONE // After check-in - no customer room-fee refund; remaining room fee follows 90/10 realtor/platform
}

enum PaymentStatus {
   INITIATED // Payment process started
   HELD // Escrow holding funds (room fee + deposit)
   PARTIALLY_RELEASED // Room fee released, deposit still in escrow
   SETTLED // All money distributed (room fee + deposit)
   REFUNDED // Cancellation refunds processed
   FAILED // Payment failed
}

enum PaymentMethod {
   PAYSTACK
   FLUTTERWAVE
}

enum RealtorStatus {
   PENDING
   APPROVED
   REJECTED
   SUSPENDED
}

enum CacStatus {
   PENDING
   APPROVED
   REJECTED
   SUSPENDED
}

enum NotificationType {
   BOOKING_CONFIRMED
   BOOKING_CANCELLED
   PAYMENT_COMPLETED
   PAYMENT_FAILED
   REVIEW_RECEIVED
   REVIEW_RESPONSE
   SYSTEM_ALERT
   PROPERTY_STATUS_CHANGE
   MESSAGE_RECEIVED
   CAC_STATUS_UPDATE
   BOOKING_REMINDER
   PAYMENT_REMINDER
   REALTOR_REGISTRATION
   CAC_VERIFICATION
   PAYOUT_COMPLETED
   PROPERTY_SUBMISSION
   REVIEW_FLAGGED
   DISPUTE_OPENED
   REALTOR_REINSTATED
}

enum RefundRequestStatus {
   PENDING_REALTOR_APPROVAL
   REALTOR_APPROVED
   REALTOR_REJECTED
   ADMIN_PROCESSING
   COMPLETED
   CANCELLED
}

enum DisputeSubject {
   ROOM_FEE // Guest disputes room fee (within 1hr of check-in)
   SECURITY_DEPOSIT // Realtor disputes deposit (within 4hr of checkout)
}

enum DisputeCategory {
   // Room Fee Categories (Guest opens)
   SAFETY_UNINHABITABLE // 100% max refund
   MAJOR_MISREPRESENTATION // 100% max refund
   MISSING_AMENITIES_CLEANLINESS // 30% max refund
   MINOR_INCONVENIENCE // 30% max refund
   // Security Deposit Categories (Realtor opens)
   PROPERTY_DAMAGE // Up to deposit amount
   MISSING_ITEMS // Up to deposit amount
   CLEANING_REQUIRED // Up to deposit amount
   OTHER_DEPOSIT_CLAIM // Up to deposit amount
}

enum DisputeResponseAction {
   ACCEPT // Accept the claim as-is
   REJECT_ESCALATE // Reject and escalate to admin
}

enum AdminDisputeDecision {
   FULL_REFUND // 100% refund (room fee) or full deposit forfeit
   PARTIAL_REFUND // 30% refund (room fee) or partial deposit deduction
   NO_REFUND // 0% refund (room fee) or full deposit to guest
}

enum DisputeFinalOutcome {
   FULL_REFUND_EXECUTED // 100% room fee + deposit to guest, booking cancelled
   PARTIAL_REFUND_EXECUTED // 30% room fee to guest, 70% split, booking continues
   NO_REFUND_EXECUTED // 0% refund, normal flow
   DEPOSIT_FORFEITED // Full deposit to realtor
   DEPOSIT_PARTIAL // Partial deposit to realtor, rest to guest
   DEPOSIT_RETURNED // Full deposit to guest
}

enum DisputeTier {
   TIER_1_SEVERE // 100% room fee refund (realtor fault: no access, fake listing, uninhabitable)
   TIER_2_PARTIAL // 30% room fee refund (partial fault: broken AC, missing amenities)
   TIER_3_ABUSE // 0% refund (guest abuse: no evidence, late dispute, false claim)
}

enum CheckInConfirmationType {
   GUEST_CONFIRMED // Guest clicked "I've entered the room"
   REALTOR_CONFIRMED // Realtor confirmed guest checked in (after official check-in time)
   AUTO_FALLBACK // Automatic confirmation 30 minutes after official check-in time
}

enum RealtorDisputeOutcome {
   WIN // Realtor proved damage, gets deduction from deposit
   LOSS // No proof or invalid claim, full deposit refunded to guest
   PARTIAL // Partial damage proven, partial deduction
}

enum EscrowEventType {
   HOLD_ROOM_FEE // Room fee moved to escrow
   HOLD_SECURITY_DEPOSIT // Security deposit moved to escrow
   RELEASE_CLEANING_FEE // Immediate release of cleaning fee to realtor
   COLLECT_SERVICE_FEE // Immediate collection of service fee by platform
   RELEASE_ROOM_FEE_SPLIT // 90% to realtor, 10% to platform (after 1-hour window)
   RELEASE_DEPOSIT_TO_CUSTOMER // Security deposit returned to customer (after 4-hour window)
   PAY_REALTOR_FROM_DEPOSIT // Deduct from deposit, pay to realtor
   PAY_BALANCE_FROM_CUSTOMER // Customer pays additional amount from new payment
   REFUND_ROOM_FEE_TO_CUSTOMER // Refund room fee from escrow to customer
   REFUND_PARTIAL_TO_CUSTOMER // Partial refund to customer after dispute
   REFUND_PARTIAL_TO_REALTOR // Partial payout to realtor after dispute
}

model JobLock {
   id         String   @id @default(cuid())
   jobName    String   @unique
   lockedAt   DateTime @default(now())
   lockedBy   String // Instance ID or hostname
   expiresAt  DateTime
   bookingIds String[] // Bookings being processed

   @@index([jobName])
   @@index([expiresAt])
   @@map("job_locks")
}

model WebhookEvent {
   id          String   @id @default(cuid())
   provider    String // PAYSTACK or FLUTTERWAVE
   eventId     String   @unique // Webhook event ID from provider
   eventType   String // charge.success, transfer.success, etc.
   status      String // PROCESSED, FAILED, DUPLICATE
   payload     Json // Full webhook payload for debugging
   processedAt DateTime @default(now())
   metadata    Json? // Additional metadata (booking ID, payment ID, etc.)

   @@index([eventId])
   @@index([provider])
   @@index([processedAt])
   @@map("webhook_events")
}

model Message {
   id          String              @id @default(cuid())
   content     String              @db.Text
   type        MessageType         @default(BOOKING_MESSAGE)
   isRead      Boolean             @default(false)
   readAt      DateTime?
   createdAt   DateTime            @default(now())
   updatedAt   DateTime            @updatedAt
   // Context: property inquiry or booking conversation
   propertyId  String?
   bookingId   String?
   // Sender and recipient
   senderId    String
   recipientId String
   // Filtering metadata
   wasFiltered Boolean             @default(false)
   violations  String[]            @default([])
   // Relations
   property    Property?           @relation(fields: [propertyId], references: [id], onDelete: Cascade)
   booking     Booking?            @relation(fields: [bookingId], references: [id], onDelete: Cascade)
   sender      User                @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
   recipient   User                @relation("ReceivedMessages", fields: [recipientId], references: [id], onDelete: Cascade)
   attachments MessageAttachment[]

   @@index([propertyId])
   @@index([bookingId])
   @@index([senderId])
   @@index([recipientId])
   @@index([createdAt])
   @@index([isRead])
   @@map("messages")
}

model MessageAttachment {
   id        String   @id @default(cuid())
   messageId String
   url       String
   type      String // IMAGE, DOCUMENT, VOICE
   filename  String
   size      Int
   createdAt DateTime @default(now())
   message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

   @@index([messageId])
   @@map("message_attachments")
}

model Favorite {
   id         String   @id @default(cuid())
   userId     String
   propertyId String
   createdAt  DateTime @default(now())

   user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
   property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

   @@unique([userId, propertyId]) // Prevent duplicate favorites
   @@index([userId])
   @@index([propertyId])
   @@map("favorites")
}

model Wallet {
   id                 String              @id @default(cuid())
   ownerType          WalletOwnerType
   ownerId            String // realtorId or 'platform'
   balanceAvailable   Decimal             @default(0) @db.Decimal(12, 2)
   balancePending     Decimal             @default(0) @db.Decimal(12, 2)
   createdAt          DateTime            @default(now())
   updatedAt          DateTime            @updatedAt
   transactions       WalletTransaction[]
   withdrawalRequests WithdrawalRequest[]

   @@unique([ownerType, ownerId])
   @@index([ownerId])
   @@map("wallets")
}

model WalletTransaction {
   id          String                  @id @default(cuid())
   walletId    String
   type        WalletTransactionType
   source      WalletTransactionSource
   amount      Decimal                 @db.Decimal(12, 2)
   referenceId String? // bookingId, paymentId, etc.
   status      WalletTransactionStatus
   metadata    Json?
   createdAt   DateTime                @default(now())
   wallet      Wallet                  @relation(fields: [walletId], references: [id], onDelete: Cascade)

   @@index([walletId])
   @@index([referenceId])
   @@index([createdAt])
   @@map("wallet_transactions")
}

model Escrow {
   id          String       @id @default(cuid())
   bookingId   String       @unique
   roomFeeHeld Decimal      @default(0) @db.Decimal(12, 2)
   depositHeld Decimal      @default(0) @db.Decimal(12, 2)
   status      EscrowStatus @default(HOLDING)
   createdAt   DateTime     @default(now())
   updatedAt   DateTime     @updatedAt
   booking     Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)

   @@index([bookingId])
   @@index([status])
   @@map("escrows")
}

model WithdrawalRequest {
   id                   String                  @id @default(cuid())
   walletId             String
   realtorId            String
   amount               Decimal                 @db.Decimal(12, 2)
   feeAmount            Decimal                 @default(0) @db.Decimal(12, 2)
   netAmount            Decimal                 @default(0) @db.Decimal(12, 2)
   feeConfigVersion     String?
   status               WithdrawalRequestStatus @default(PENDING)
   requestedAt          DateTime                @default(now())
   processedAt          DateTime?
   completedAt          DateTime?
   failedAt             DateTime?
   failureReason        String?
   paystackTransferId   String?
   paystackTransferCode String?
   retryCount           Int                     @default(0)
   metadata             Json?

   wallet  Wallet  @relation(fields: [walletId], references: [id], onDelete: Cascade)
   realtor Realtor @relation(fields: [realtorId], references: [id], onDelete: Cascade)

   @@index([realtorId])
   @@index([walletId])
   @@index([status])
   @@map("withdrawal_requests")
}

model EmailJob {
   id                String         @id @default(cuid())
   to                String[]
   subject           String
   html              String         @db.Text
   attachments       Json?
   status            EmailJobStatus @default(PENDING)
   attempts          Int            @default(0)
   maxAttempts       Int            @default(5)
   nextAttemptAt     DateTime       @default(now())
   lastError         String?
   provider          String?
   providerMessageId String?
   lockedAt          DateTime?
   lockedBy          String?
   sentAt            DateTime?
   createdAt         DateTime       @default(now())
   updatedAt         DateTime       @updatedAt

   @@index([status, nextAttemptAt])
   @@index([createdAt])
   @@map("email_jobs")
}

enum WalletOwnerType {
   REALTOR
   PLATFORM
}

enum WalletTransactionType {
   CREDIT
   DEBIT
}

enum WalletTransactionSource {
   CLEANING_FEE
   ROOM_FEE
   COMMISSION
   SERVICE_FEE
   WITHDRAWAL
   WITHDRAWAL_FEE
   PROCESSING_FEE_ADJUSTMENT
   REFUND
   ADJUSTMENT
   CANCELLATION
   SECURITY_DEPOSIT
}

enum WalletTransactionStatus {
   COMPLETED
   PENDING
   FAILED
}

enum EscrowStatus {
   HOLDING
   RELEASED
   REFUNDED
   PARTIAL_RELEASED
}

enum WithdrawalRequestStatus {
   PENDING // Withdrawal requested, funds locked
   PROCESSING // Paystack transfer initiated
   COMPLETED // Successfully paid to realtor
   FAILED // Transfer failed, funds restored
   CANCELLED // Cancelled by admin/realtor
}

enum EmailJobStatus {
   PENDING
   PROCESSING
   SENT
   FAILED
}

enum MessageType {
   INQUIRY // Pre-booking Q&A about property (limited)
   BOOKING_MESSAGE // Regular message within active booking (full messaging)
   SYSTEM // System-generated messages (check-in info, access codes, etc.)
}

model Waitlist {
   id          String    @id @default(cuid())
   email       String    @unique
   fullName    String?
   companyName String?
   phone       String?
   message     String?
   status      String    @default("pending") // pending, approved, rejected
   source      String? // Where they heard about us
   ipAddress   String?
   userAgent   String?
   createdAt   DateTime  @default(now())
   updatedAt   DateTime  @updatedAt
   notifiedAt  DateTime? // When they were notified about launch

   @@index([status])
   @@index([createdAt])
   @@map("waitlist")
}
